<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - RecoveryLink</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px 0;
        }

        .nav-btn {
            width: 100%;
            padding: 15px 25px;
            border: none;
            background: none;
            text-align: left;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .nav-btn.active {
            background: #50BFC3;
            color: white;
        }

        .content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page { display: none; }
        .page.active { display: block; }

        .filters {
            margin-bottom: 20px;
        }

        .filter-btn {
            padding: 8px 16px;
            margin-right: 10px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .filter-btn.active {
            background: #50BFC3;
            color: white;
        }

        .patient-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table-header {
            background: #f8f9fa;
            padding: 15px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
        }

        .patient-row {
            padding: 15px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .patient-row:last-child { border-bottom: none; }

        .patient-row.CRITICAL { background: #fff5f5; border-left: 4px solid #e53e3e; }
        .patient-row.CHECK { background: #fffbeb; border-left: 4px solid #d69e2e; }
        .patient-row.STABLE { background: #f0fff4; border-left: 4px solid #38a169; }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.CRITICAL { background: #fed7d7; color: #c53030; }
        .status-badge.CHECK { background: #fef5e7; color: #d69e2e; }
        .status-badge.STABLE { background: #c6f6d5; color: #2f855a; }

        .alert-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid #e53e3e;
        }

        .chat-window {
            background: white;
            border-radius: 8px;
            height: 400px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            border-bottom: 1px solid #eee;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 70%;
        }

        .message.doctor {
            background: #50BFC3;
            color: white;
            margin-left: auto;
        }

        .message.patient {
            background: #f1f3f4;
        }

        .chat-input {
            display: flex;
            padding: 15px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .btn-primary { background: #50BFC3; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
    </style>
</head>
<body>
    <div class="sidebar">
        <button class="nav-btn active" data-page="dashboard">ðŸ“Š Dashboard</button>
        <button class="nav-btn" data-page="alerts">ðŸš¨ Alerts</button>
        <button class="nav-btn" data-page="chat">ðŸ’¬ Chat</button>
        <button class="nav-btn logout">ðŸšª Logout</button>
    </div>

    <div class="content">
        <section id="dashboard" class="page active">
            <h2>Patient Triage Dashboard</h2>
            
            <div class="filters">
                <button class="filter-btn active" onclick="filterStatus('ALL')">All Patients</button>
                <button class="filter-btn" onclick="filterStatus('CRITICAL')">Critical</button>
                <button class="filter-btn" onclick="filterStatus('CHECK')">Warning</button>
                <button class="filter-btn" onclick="filterStatus('STABLE')">Stable</button>
                <button class="btn btn-secondary" onclick="exportCSV()">Export CSV</button>
            </div>

            <div class="patient-table">
                <div class="table-header">
                    <span>Patient</span>
                    <span>Pain Level</span>
                    <span>Trend</span>
                    <span>Status</span>
                    <span>Actions</span>
                </div>
                <div id="patientTable"></div>
            </div>
        </section>

        <section id="alerts" class="page">
            <h2>ðŸš¨ Real-time Alerts</h2>
            <div id="alertsList"></div>
        </section>

        <section id="chat" class="page">
            <h2>ðŸ’¬ Patient Chat</h2>
            <div style="margin-bottom: 20px;">
                <select id="patientSelect" onchange="loadChat()">
                    <option value="">Select Patient</option>
                </select>
            </div>
            <div class="chat-window" id="chatWindow" style="display: none;">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Type your message...">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </section>
    </div>

    <script type="module">
        import { db } from './firebase.js';
        import { 
            collection, 
            onSnapshot, 
            addDoc, 
            serverTimestamp, 
            query, 
            where, 
            orderBy 
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        let currentChatId = null;
        let currentPatientId = null;

        // Navigation
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const page = btn.dataset.page;
                
                if (btn.classList.contains('logout')) {
                    localStorage.clear();
                    window.location.href = 'login.html';
                    return;
                }

                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                document.getElementById(page).classList.add('active');
            });
        });

        // Real-time Patient Dashboard
        function loadPatientTable() {
            const table = document.getElementById('patientTable');
            
            onSnapshot(collection(db, 'checkins'), snapshot => {
                const patients = new Map();
                
                snapshot.forEach(doc => {
                    const checkin = doc.data();
                    const patientId = checkin.patientId;
                    
                    if (!patients.has(patientId) || 
                        checkin.timestamp?.toDate() > patients.get(patientId).timestamp?.toDate()) {
                        patients.set(patientId, checkin);
                    }
                });

                table.innerHTML = '';
                
                patients.forEach(checkin => {
                    const status = checkin.pain >= 8 ? 'CRITICAL' : 
                                 checkin.pain >= 5 ? 'CHECK' : 'STABLE';
                    
                    const trend = 'ðŸ“ˆ'; // Could calculate from historical data
                    
                    const row = document.createElement('div');
                    row.className = `patient-row ${status}`;
                    row.innerHTML = `
                        <span>${checkin.patientId}</span>
                        <span>${checkin.pain}/10</span>
                        <span>${trend}</span>
                        <span><span class="status-badge ${status}">${status}</span></span>
                        <span>
                            <button class="btn btn-primary" onclick="openPatient('${checkin.patientId}')">
                                View
                            </button>
                        </span>
                    `;
                    table.appendChild(row);
                });
            });
        }

        // Real-time Alerts
        function loadAlerts() {
            const alertsList = document.getElementById('alertsList');
            
            onSnapshot(collection(db, 'alerts'), snapshot => {
                alertsList.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const alert = doc.data();
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert-card';
                    alertDiv.innerHTML = `
                        <strong>ðŸš¨ ${alert.level.toUpperCase()}</strong><br>
                        Patient: ${alert.patientId}<br>
                        Pain Level: ${alert.pain}/10<br>
                        <small>Created: ${alert.createdAt?.toDate().toLocaleString()}</small>
                    `;
                    alertsList.appendChild(alertDiv);
                });

                if (alertsList.children.length === 0) {
                    alertsList.innerHTML = '<p style="color: #28a745;">âœ… No active alerts</p>';
                }
            });
        }

        // Load Patient List for Chat
        function loadPatientList() {
            const select = document.getElementById('patientSelect');
            
            onSnapshot(collection(db, 'patients'), snapshot => {
                select.innerHTML = '<option value="">Select Patient</option>';
                
                snapshot.forEach(doc => {
                    const patient = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = patient.name;
                    select.appendChild(option);
                });
            });
        }

        // Load Chat Messages
        window.loadChat = function() {
            const patientId = document.getElementById('patientSelect').value;
            if (!patientId) return;

            currentPatientId = patientId;
            currentChatId = `doctor_${patientId}`;
            
            document.getElementById('chatWindow').style.display = 'flex';
            
            const messagesDiv = document.getElementById('chatMessages');
            
            const q = query(
                collection(db, 'messages'),
                where('chatId', '==', currentChatId),
                orderBy('timestamp')
            );
            
            onSnapshot(q, snapshot => {
                messagesDiv.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const message = doc.data();
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${message.sender}`;
                    messageDiv.textContent = message.text;
                    messagesDiv.appendChild(messageDiv);
                });
                
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            });
        };

        // Send Message
        window.sendMessage = async function() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentChatId) return;

            await addDoc(collection(db, 'messages'), {
                chatId: currentChatId,
                sender: 'doctor',
                text: text,
                timestamp: serverTimestamp()
            });

            input.value = '';
        };

        // Filter Functions
        window.filterStatus = function(status) {
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.patient-row').forEach(row => {
                if (status === 'ALL' || row.classList.contains(status)) {
                    row.style.display = 'grid';
                } else {
                    row.style.display = 'none';
                }
            });
        };

        // Export CSV
        window.exportCSV = function() {
            let csv = 'Patient,Pain Level,Status,Timestamp\n';
            
            document.querySelectorAll('.patient-row').forEach(row => {
                if (row.style.display !== 'none') {
                    const cells = row.querySelectorAll('span');
                    const patient = cells[0].textContent;
                    const pain = cells[1].textContent;
                    const status = cells[3].textContent;
                    csv += `${patient},${pain},${status},${new Date().toISOString()}\n`;
                }
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `patients-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };

        window.openPatient = function(patientId) {
            document.getElementById('patientSelect').value = patientId;
            loadChat();
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-page="chat"]').classList.add('active');
            
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('chat').classList.add('active');
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadPatientTable();
            loadAlerts();
            loadPatientList();
        });

        // Auto-create sample data for demo
        setTimeout(async () => {
            try {
                // Sample patient
                await addDoc(collection(db, 'patients'), {
                    name: 'Rahul Sharma',
                    assignedDoctorId: 'doctor1'
                });

                // Sample check-in with alert
                await addDoc(collection(db, 'checkins'), {
                    patientId: 'Rahul Sharma',
                    pain: 8,
                    symptoms: ['fever', 'swelling'],
                    timestamp: serverTimestamp()
                });

                // Auto-generate alert
                await addDoc(collection(db, 'alerts'), {
                    patientId: 'Rahul Sharma',
                    pain: 8,
                    level: 'critical',
                    createdAt: serverTimestamp()
                });
            } catch (error) {
                console.log('Demo data creation skipped:', error.message);
            }
        }, 2000);
    </script>
</body>
</html>
