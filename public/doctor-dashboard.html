<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor Dashboard - RecoveryLink</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }
        .header {
            background: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .welcome {
            font-size: 24px;
            color: #2c3e50;
        }
        .logout-btn {
            padding: 8px 16px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .alert-card {
            border-left: 4px solid #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .alert-card.warning {
            border-left-color: #ffc107;
            background: #fff3cd;
            color: #856404;
        }
        .alert-card.critical {
            border-left-color: #dc3545;
            background: #f8d7da;
            color: #721c24;
        }
        .patient-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .patient-table th,
        .patient-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        .patient-table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        .pain-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        .pain-low { background: #d4edda; color: #155724; }
        .pain-medium { background: #fff3cd; color: #856404; }
        .pain-high { background: #f8d7da; color: #721c24; }
        .empty-state {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
        }
        .stat-label {
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="welcome">
            <span id="greetingText">Good Morning</span>, <span id="doctorName">Doctor</span>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">
        <!-- STATS -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalPatients">0</div>
                <div class="stat-label">Total Patients</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeAlerts">0</div>
                <div class="stat-label">Active Alerts</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayCheckins">0</div>
                <div class="stat-label">Today's Check-ins</div>
            </div>
        </div>

        <!-- ALERTS -->
        <div class="card">
            <h2>ðŸš¨ Active Alerts</h2>
            <div id="alertsList">
                <div class="empty-state">Loading alerts...</div>
            </div>
        </div>

        <!-- RECENT CHECK-INS -->
        <div class="card">
            <h2>ðŸ“Š Recent Check-ins</h2>
            <table class="patient-table">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Pain Level</th>
                        <th>Symptoms</th>
                        <th>Time</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="checkinsTable">
                    <tr>
                        <td colspan="5" class="empty-state">Loading check-ins...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        // BULLETPROOF FIREBASE IMPORTS
        import { auth, db } from './firebase.js';
        import { 
            onAuthStateChanged,
            signOut
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { 
            doc,
            getDoc,
            collection,
            query,
            orderBy,
            limit,
            where,
            onSnapshot,
            updateDoc
        } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        console.log("âœ… Doctor dashboard JS loaded");

        let currentUser = null;

        // BULLETPROOF AUTH STATE
        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // ROLE VALIDATION
            try {
                const userDoc = await getDoc(doc(db, 'users', user.uid));
                if (!userDoc.exists() || userDoc.data().role !== 'doctor') {
                    console.warn("Access denied: not a doctor");
                    await signOut(auth);
                    window.location.href = 'login.html';
                    return;
                }
            } catch (error) {
                console.error("Role validation failed:", error);
                window.location.href = 'login.html';
                return;
            }

            currentUser = user;
            
            // IMMEDIATE UI UPDATE
            setTimeBasedGreeting();
            document.getElementById('doctorName').textContent = 'Doctor';
            
            // LOAD DATA (non-blocking)
            await loadDoctorProfile();
            setupRealtimeListeners();
        });

        // TIME-BASED GREETING
        function setTimeBasedGreeting() {
            const hour = new Date().getHours();
            let greetingText = "Good Morning";
            if (hour >= 12 && hour < 17) greetingText = "Good Afternoon";
            if (hour >= 17) greetingText = "Good Evening";
            document.getElementById('greetingText').textContent = greetingText;
        }

        // LOAD DOCTOR PROFILE
        async function loadDoctorProfile() {
            try {
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    if (userData.name) {
                        document.getElementById('doctorName').textContent = userData.name;
                    }
                }
            } catch (error) {
                console.error('Profile load failed:', error);
            }
        }

        // SETUP REAL-TIME LISTENERS
        function setupRealtimeListeners() {
            // LISTEN TO ALERTS
            const alertsQuery = query(
                collection(db, 'alerts'),
                where('seen', '==', false),
                orderBy('createdAt', 'desc'),
                limit(10)
            );

            onSnapshot(alertsQuery, (snapshot) => {
                updateAlertsUI(snapshot.docs);
                document.getElementById('activeAlerts').textContent = snapshot.size;
            });

            // LISTEN TO RECENT CHECK-INS
            const checkinsQuery = query(
                collection(db, 'checkins'),
                orderBy('createdAt', 'desc'),
                limit(20)
            );

            onSnapshot(checkinsQuery, async (snapshot) => {
                await updateCheckinsUI(snapshot.docs);
                
                // COUNT TODAY'S CHECK-INS
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayCount = snapshot.docs.filter(doc => {
                    const checkinDate = doc.data().createdAt?.toDate();
                    return checkinDate && checkinDate >= today;
                }).length;
                
                document.getElementById('todayCheckins').textContent = todayCount;
            });

            // COUNT TOTAL PATIENTS
            const usersQuery = query(
                collection(db, 'users'),
                where('role', '==', 'patient')
            );

            onSnapshot(usersQuery, (snapshot) => {
                document.getElementById('totalPatients').textContent = snapshot.size;
            });
        }

        // UPDATE ALERTS UI
        function updateAlertsUI(alertDocs) {
            const alertsList = document.getElementById('alertsList');
            
            if (alertDocs.length === 0) {
                alertsList.innerHTML = '<div class="empty-state">No active alerts</div>';
                return;
            }

            alertsList.innerHTML = alertDocs.map(doc => {
                const alert = doc.data();
                const alertClass = alert.level === 'CRITICAL' ? 'critical' : 'warning';
                const time = alert.createdAt?.toDate()?.toLocaleTimeString() || 'Unknown time';
                
                return `
                    <div class="alert-card ${alertClass}" onclick="markAlertSeen('${doc.id}')">
                        <strong>${alert.level}:</strong> ${alert.message}
                        <br><small>Time: ${time}</small>
                    </div>
                `;
            }).join('');
        }

        // UPDATE CHECK-INS UI
        async function updateCheckinsUI(checkinDocs) {
            const checkinsTable = document.getElementById('checkinsTable');
            
            if (checkinDocs.length === 0) {
                checkinsTable.innerHTML = '<tr><td colspan="5" class="empty-state">No check-ins yet</td></tr>';
                return;
            }

            // GET PATIENT NAMES
            const patientNames = {};
            for (const doc of checkinDocs) {
                const patientId = doc.data().patientId;
                if (!patientNames[patientId]) {
                    try {
                        const userDoc = await getDoc(doc(db, 'users', patientId));
                        patientNames[patientId] = userDoc.exists() ? userDoc.data().name || 'Unknown Patient' : 'Unknown Patient';
                    } catch (error) {
                        patientNames[patientId] = 'Unknown Patient';
                    }
                }
            }

            checkinsTable.innerHTML = checkinDocs.map(doc => {
                const checkin = doc.data();
                const patientName = patientNames[checkin.patientId] || 'Unknown Patient';
                const time = checkin.createdAt?.toDate()?.toLocaleString() || 'Unknown time';
                const symptoms = Array.isArray(checkin.symptoms) ? checkin.symptoms.join(', ') : (checkin.symptoms || 'None');
                
                let painClass = 'pain-low';
                if (checkin.pain >= 4 && checkin.pain <= 6) painClass = 'pain-medium';
                if (checkin.pain >= 7) painClass = 'pain-high';
                
                return `
                    <tr>
                        <td>${patientName}</td>
                        <td><span class="pain-badge ${painClass}">${checkin.pain}/10</span></td>
                        <td>${symptoms}</td>
                        <td>${time}</td>
                        <td>${checkin.notes || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // MARK ALERT AS SEEN
        window.markAlertSeen = async function(alertId) {
            try {
                await updateDoc(doc(db, 'alerts', alertId), {
                    seen: true,
                    seenAt: new Date()
                });
            } catch (error) {
                console.error('Failed to mark alert as seen:', error);
            }
        };

        // LOGOUT
        window.logout = async function() {
            try {
                await signOut(auth);
                window.location.href = 'login.html';
            } catch (error) {
                console.error('Logout failed:', error);
            }
        };
    </script>
</body>
</html>
