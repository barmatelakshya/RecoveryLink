<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RecoveryLink â€” Patient Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: Inter, system-ui, sans-serif;
    }

    body {
      background: #f8fafc;
      color: #0f172a;
    }

    .app-layout {
      display: flex;
      height: 100vh;
    }

    .sidebar {
      width: 240px;
      background: #1e293b;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 24px 0;
    }

    .logo {
      padding: 0 24px 32px;
      font-size: 18px;
      font-weight: 700;
      color: #50BFC3;
    }

    .nav-link {
      display: block;
      padding: 12px 24px;
      color: #94a3b8;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-link:hover {
      background: #334155;
      color: white;
    }

    .nav-link.active {
      background: #50BFC3;
      color: white;
      font-weight: 600;
    }

    .logout {
      margin-top: auto;
      padding: 24px;
      color: #64748b;
      cursor: pointer;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .top-bar {
      background: white;
      padding: 20px 32px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .greeting {
      font-size: 24px;
      font-weight: 700;
    }

    .avatar {
      width: 40px;
      height: 40px;
      background: #50BFC3;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .page {
      display: none;
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    .page.active {
      display: block;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .status-strip {
      background: white;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .badge {
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge.success {
      background: #dcfce7;
      color: #166534;
    }

    .badge.warning {
      background: #fef3c7;
      color: #92400e;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .metric {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }

    .metric span {
      display: block;
      color: #64748b;
      font-size: 14px;
      margin-bottom: 8px;
    }

    .metric strong {
      font-size: 20px;
      color: #0f172a;
    }

    .checkin-form {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-bottom: 24px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #374151;
    }

    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
    }

    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .submit-btn {
      background: #50BFC3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .submit-btn:hover {
      background: #3da8ac;
    }
  </style>
</head>
<body>

  <div class="app-layout">
    <aside class="sidebar">
      <div class="logo">RecoveryLink</div>

      <nav>
        <a class="nav-link active" data-page="dashboard">Dashboard</a>
        <a class="nav-link" data-page="history">Health History</a>
        <a class="nav-link" data-page="messages">Messages</a>
        <a class="nav-link" data-page="profile">Profile</a>
      </nav>

      <div class="logout">Logout</div>
    </aside>

    <main class="main-content">
      <!-- HEADER -->
      <header class="top-bar">
        <div class="greeting">Good Morning, Patient</div>
        <div class="avatar">P</div>
      </header>

      <!-- DASHBOARD PAGE -->
      <section id="dashboard" class="page active">
        <div class="container">

          <!-- RECOVERY STATUS STRIP -->
          <div class="status-strip">
            <div>
              <span class="label">Recovery Status</span>
              <strong id="recoveryProgress">Loading...</strong>
            </div>
            <div class="badge warning" id="riskBadge">Loading...</div>
          </div>

          <!-- HEALTH METRICS -->
          <div class="metrics">
            <div class="metric">
              <span>Pain Trend</span>
              <strong id="painTrend">Loading...</strong>
            </div>
            <div class="metric">
              <span>Last Check-in</span>
              <strong id="lastCheckin">Loading...</strong>
            </div>
            <div class="metric">
              <span>Days Tracked</span>
              <strong id="daysTracked">Loading...</strong>
            </div>
          </div>

          <!-- DAILY CHECK-IN FORM -->
          <div class="checkin-form">
            <h3 style="margin-bottom: 20px; color: #374151;">Daily Check-in</h3>
            
            <div class="form-group">
              <label for="painLevel">Pain Level (1-10)</label>
              <select id="painLevel">
                <option value="">Select pain level</option>
                <option value="1">1 - No pain</option>
                <option value="2">2 - Very mild</option>
                <option value="3">3 - Mild</option>
                <option value="4">4 - Moderate</option>
                <option value="5">5 - Moderate</option>
                <option value="6">6 - Moderately severe</option>
                <option value="7">7 - Severe</option>
                <option value="8">8 - Very severe</option>
                <option value="9">9 - Extreme</option>
                <option value="10">10 - Worst possible</option>
              </select>
            </div>

            <div class="form-group">
              <label>Symptoms (check all that apply)</label>
              <div class="checkbox-group">
                <div class="checkbox-item">
                  <input type="checkbox" name="symptoms" value="nausea" id="nausea">
                  <label for="nausea">Nausea</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="symptoms" value="fatigue" id="fatigue">
                  <label for="fatigue">Fatigue</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="symptoms" value="dizziness" id="dizziness">
                  <label for="dizziness">Dizziness</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="symptoms" value="swelling" id="swelling">
                  <label for="swelling">Swelling</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="symptoms" value="stiffness" id="stiffness">
                  <label for="stiffness">Stiffness</label>
                </div>
                <div class="checkbox-item">
                  <input type="checkbox" name="symptoms" value="none" id="none">
                  <label for="none">None</label>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="notes">Additional Notes</label>
              <textarea id="notes" rows="3" placeholder="How are you feeling today?"></textarea>
            </div>

            <button class="submit-btn" id="submitCheckin">Submit Check-in</button>
          </div>

        </div>
      </section>

      <!-- HEALTH HISTORY PAGE -->
      <section id="history" class="page">
        <div class="container">
          <h2>Health History</h2>
          <p>Previous check-ins and recovery progress will appear here.</p>
        </div>
      </section>

      <!-- MESSAGES PAGE -->
      <section id="messages" class="page">
        <div class="container">
          <h2>Messages</h2>
          <p>Chat with your healthcare team.</p>
        </div>
      </section>

      <!-- PROFILE PAGE -->
      <section id="profile" class="page">
        <div class="container">
          <h2>Profile</h2>
          <p>Your personal and medical information.</p>
        </div>
      </section>

    </main>
  </div>

  <script type="module">
    console.log("Patient dashboard loading...");

    // Wait for DOM
    document.addEventListener('DOMContentLoaded', async function() {
      try {
        // Import Firebase
        const { auth, db } = await import("./firebase.js");
        const { onAuthStateChanged, signOut } = await import("https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js");
        const { addDoc, collection, serverTimestamp, setDoc, doc, getDoc } = await import("https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js");

        console.log("Firebase loaded");

        // Check authentication
        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            console.log("No user, redirecting to login");
            window.location.href = "login.html";
            return;
          }

          // Check if user is patient
          const userDoc = await getDoc(doc(db, "users", user.uid));
          if (!userDoc.exists() || userDoc.data().role !== "patient") {
            console.log("Not a patient, redirecting");
            window.location.href = "login.html";
            return;
          }

          console.log("Patient authenticated:", user.uid);
          initializePatientDashboard(user, userDoc.data());
        });

        // Initialize dashboard
        function initializePatientDashboard(user, userData) {
          // Time-based greeting
          const hour = new Date().getHours();
          let greetingText = "Good Morning";
          if (hour >= 12 && hour < 17) greetingText = "Good Afternoon";
          if (hour >= 17) greetingText = "Good Evening";
          
          // Update greeting
          document.querySelector('.greeting').textContent = `${greetingText}, ${userData.name || 'Patient'}`;
          document.querySelector('.avatar').textContent = (userData.name || 'Patient').charAt(0).toUpperCase();
          
          // IMMEDIATE UI UPDATE (no loading dependencies)
          document.getElementById('recoveryProgress').textContent = 'On Track';
          document.getElementById('riskBadge').textContent = 'Low Risk';
          document.getElementById('riskBadge').className = 'badge success';
          document.getElementById('painTrend').textContent = 'Improving';
          document.getElementById('lastCheckin').textContent = 'Today';
          document.getElementById('daysTracked').textContent = '6 days';

          // Setup navigation
          setupNavigation();
          
          // Setup daily check-in
          setupDailyCheckin(user, userData);
          
          // Setup logout
          setupLogout();
        }

        // Navigation setup
        function setupNavigation() {
          const navLinks = document.querySelectorAll('.nav-link');
          const pages = document.querySelectorAll('.page');

          navLinks.forEach(link => {
            link.onclick = function() {
              // Remove active from all
              navLinks.forEach(l => l.classList.remove('active'));
              pages.forEach(p => p.classList.remove('active'));

              // Add active to clicked
              link.classList.add('active');
              const targetPage = document.getElementById(link.dataset.page);
              if (targetPage) {
                targetPage.classList.add('active');
              }
            };
          });
        }

        // Daily check-in setup
        function setupDailyCheckin(user, userData) {
          const submitBtn = document.getElementById('submitCheckin');
          if (submitBtn) {
            submitBtn.onclick = async function() {
              const painLevel = document.getElementById('painLevel').value;
              const symptoms = Array.from(document.querySelectorAll('input[name="symptoms"]:checked')).map(cb => cb.value);
              const notes = document.getElementById('notes').value;

              if (!painLevel) {
                alert('Please select your pain level');
                return;
              }

              try {
                // Save check-in
                await addDoc(collection(db, "checkins"), {
                  patientId: user.uid,
                  patientName: userData.name || 'Demo Patient',
                  painLevel: parseInt(painLevel),
                  symptoms: symptoms,
                  notes: notes,
                  condition: userData.condition || 'Recovery',
                  date: new Date().toISOString().split('T')[0],
                  createdAt: serverTimestamp()
                });

                // Create alert if pain is high
                if (parseInt(painLevel) >= 7) {
                  await addDoc(collection(db, "alerts"), {
                    patientId: user.uid,
                    patientName: userData.name || 'Demo Patient',
                    type: parseInt(painLevel) >= 8 ? "CRITICAL" : "WARNING",
                    painLevel: parseInt(painLevel),
                    symptoms: symptoms,
                    message: `Pain level reported: ${painLevel}/10`,
                    resolved: false,
                    createdAt: serverTimestamp()
                  });
                }

                alert('Check-in submitted successfully!');
                
                // Reset form
                document.getElementById('painLevel').value = '';
                document.querySelectorAll('input[name="symptoms"]:checked').forEach(cb => cb.checked = false);
                document.getElementById('notes').value = '';

              } catch (error) {
                console.error('Error submitting check-in:', error);
                alert('Error submitting check-in. Please try again.');
              }
            };
          }
        }

        // Logout setup
        function setupLogout() {
          const logoutBtn = document.querySelector('.logout');
          if (logoutBtn) {
            logoutBtn.onclick = async function() {
              try {
                await signOut(auth);
                window.location.href = "login.html";
              } catch (error) {
                console.error('Logout error:', error);
              }
            };
          }
        }

      } catch (error) {
        console.error('Error loading patient dashboard:', error);
        alert('Error loading dashboard. Please refresh the page.');
      }
    });
  </script>

</body>
</html>
