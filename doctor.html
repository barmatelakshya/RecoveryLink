<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RecoveryLink â€” Doctor Dashboard</title>
  <style>
    * {
      box-sizing: border-box;
      font-family: Inter, system-ui, sans-serif;
    }

    body {
      margin: 0;
      background: #f8fafc;
      color: #0f172a;
      display: flex;
      height: 100vh;
    }

    /* SIDEBAR */
    .sidebar {
      width: 240px;
      background: #1e293b;
      color: white;
      display: flex;
      flex-direction: column;
      padding: 24px 0;
    }

    .sidebar-logo {
      padding: 0 24px 32px;
      font-size: 18px;
      font-weight: 700;
      color: #14b8a6;
    }

    .sidebar-nav {
      flex: 1;
    }

    .nav-link {
      display: block;
      padding: 12px 24px;
      color: #94a3b8;
      text-decoration: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .nav-link:hover {
      background: #334155;
      color: white;
    }

    .nav-link.active {
      background: #14b8a6;
      color: white;
      font-weight: 600;
    }

    /* SECTION VISIBILITY */
    .section {
      display: none;
    }

    .section.active {
      display: block;
    }

    .sidebar-logout {
      padding: 24px;
      color: #64748b;
      cursor: pointer;
    }

    /* MAIN CONTENT */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .top-bar {
      background: white;
      padding: 20px 32px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .top-bar h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 700;
    }

    .filters {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .filter-btn {
      padding: 8px 16px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .filter-btn.active {
      background: #2563eb;
      color: white;
      border-color: #2563eb;
    }

    .search-input {
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      width: 200px;
    }

    /* CONTENT AREA */
    .content {
      flex: 1;
      padding: 32px;
      overflow-y: auto;
    }

    /* PAGE SECTIONS */
    .page-section {
      display: none;
    }

    .page-section.active {
      display: block;
    }

    /* PATIENT CARDS STYLING */
    .patient-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      border-left: 4px solid #e2e8f0;
    }

    .patient-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }

    .patient-card.critical {
      border-left-color: #ef4444;
      background: linear-gradient(135deg, #fef2f2 0%, white 100%);
    }

    .patient-card.check {
      border-left-color: #f59e0b;
      background: linear-gradient(135deg, #fffbeb 0%, white 100%);
    }

    .patient-card.stable {
      border-left-color: #10b981;
      background: linear-gradient(135deg, #f0fdf4 0%, white 100%);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .patient-name {
      font-weight: 600;
      font-size: 16px;
      color: #374151;
    }

    .trend-indicator {
      font-size: 14px;
      font-weight: 600;
    }

    .trend-rising {
      color: #ef4444;
    }

    .trend-stable {
      color: #f59e0b;
    }

    .trend-improving {
      color: #10b981;
    }

    .card-stats {
      display: flex;
      justify-content: space-between;
      margin-bottom: 16px;
    }

    .stat-item {
      text-align: center;
    }

    .stat-value {
      font-size: 20px;
      font-weight: 700;
      color: #374151;
    }

    .stat-label {
      font-size: 12px;
      color: #64748b;
    }

    .card-actions {
      display: flex;
      gap: 8px;
    }

    .action-btn {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #e2e8f0;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .action-btn:hover {
      background: #f8fafc;
    }

    .video-btn {
      background: #50BFC3;
      color: white;
      border-color: #50BFC3;
    }

    .video-btn:hover {
      background: #3da8ac;
    }

    .status-badge {
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-stable {
      background: #dcfce7;
      color: #166534;
    }

    .status-check {
      background: #fef3c7;
      color: #92400e;
    }

    .status-critical {
      background: #fee2e2;
      color: #dc2626;
    }

    .pain-level {
      font-weight: 600;
      font-size: 16px;
    }

    .pain-critical {
      color: #dc2626;
    }

    .pain-moderate {
      color: #d97706;
    }

    .pain-stable {
      color: #059669;
    }

    .no-data {
      text-align: center;
      padding: 40px;
      color: #64748b;
    }

    /* PATIENT DETAIL PANEL */
    .patient-panel {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: white;
      box-shadow: -4px 0 12px rgba(0,0,0,0.1);
      transition: right 0.3s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .patient-panel.open {
      right: 0;
    }

    .panel-header {
      padding: 20px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .panel-close {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #64748b;
    }

    .panel-content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }

    .patient-info {
      margin-bottom: 24px;
    }

    .info-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .info-label {
      color: #64748b;
    }

    .info-value {
      font-weight: 600;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
      margin: 24px 0 12px 0;
      color: #374151;
    }

    /* ALERTS STYLING */
    .alert-card {
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .alert-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }

    .alert-card.critical {
      background: #fef2f2;
      border-left: 4px solid #ef4444;
    }

    .alert-card.warning {
      background: #fffbeb;
      border-left: 4px solid #f59e0b;
    }

    .alert-header {
      display: flex;
      justify-content: between;
      align-items: center;
      margin-bottom: 8px;
    }

    .alert-patient {
      font-weight: 600;
      color: #374151;
    }

    .alert-time {
      font-size: 12px;
      color: #64748b;
    }

    .alert-message {
      font-size: 14px;
      color: #475569;
      margin-bottom: 12px;
    }

    .resolve-btn {
      background: #10b981;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 12px;
      cursor: pointer;
    }

    /* CHAT STYLING */
    .chat-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }

    .chat-message {
      margin-bottom: 12px;
      padding: 8px 12px;
      border-radius: 8px;
      max-width: 80%;
    }

    .chat-message.doctor {
      background: #dbeafe;
      margin-left: auto;
      text-align: right;
    }

    .chat-message.patient {
      background: #f3f4f6;
    }

    .chat-input-container {
      display: flex;
      gap: 8px;
    }

    .chat-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
    }

    .send-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">RecoveryLink</div>
    
    <nav class="sidebar-nav">
      <a class="nav-link active" data-target="dashboard-section">Patients</a>
      <a class="nav-link" data-target="alerts-section">Alerts</a>
      <a class="nav-link" data-target="messages-section">Messages</a>
      <a class="nav-link" data-target="settings-section">Settings</a>
    </nav>

    <div class="sidebar-logout" id="logoutBtn">Logout</div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">
    
    <!-- TOP BAR -->
    <div class="top-bar">
      <h1>Patient Triage Board</h1>
      <div class="filters">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="critical">Critical</button>
        <button class="filter-btn" data-filter="stable">Stable</button>
        <input type="text" class="search-input" placeholder="Search patient..." id="searchInput">
      </div>
    </div>

    <!-- CONTENT -->
    <div class="content">
      
      <!-- PATIENTS SECTION -->
      <section id="patientsSection" class="section active">
        <!-- EXECUTIVE STATS ROW -->
        <div class="stats-row" style="display: flex; gap: 20px; margin-bottom: 20px;">
          <div class="stat-card" style="flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <div style="color: #50BFC3; font-size: 24px; font-weight: 700;" id="totalPatients">0</div>
            <div style="color: #64748b; font-size: 14px;">Tracked Patients</div>
          </div>
          <div class="stat-card" style="flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <div style="color: #ef4444; font-size: 24px; font-weight: 700;" id="criticalAlerts">0</div>
            <div style="color: #64748b; font-size: 14px;">Critical Alerts</div>
          </div>
          <div class="stat-card" style="flex: 1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
            <div style="color: #f59e0b; font-size: 24px; font-weight: 700;" id="unreadMessages">0</div>
            <div style="color: #64748b; font-size: 14px;">Unread Messages</div>
          </div>
        </div>

        <!-- ALERTS PANEL -->
        <div class="alerts-panel" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
          <h3 style="margin: 0 0 16px 0; color: #374151;">ðŸš¨ Active Alerts</h3>
          <div id="alertsContainer">
            <div class="no-data">No active alerts</div>
          </div>
        </div>

        <!-- ADD PATIENT SECTION -->
        <div class="add-patient" style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
          <h3 style="margin: 0 0 16px 0; color: #374151;">Add Patient to Track</h3>
          <div style="display: flex; gap: 12px; align-items: center;">
            <input id="patientIdInput" placeholder="Enter Patient ID" style="flex: 1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 6px; font-size: 14px;" />
            <button id="addPatientBtn" style="padding: 10px 20px; background: #2563eb; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Add Patient</button>
          </div>
          <p id="addPatientMsg" style="margin: 12px 0 0 0; font-size: 14px;"></p>
        </div>

        <!-- PATIENT CARDS GRID -->
        <div class="patients-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px;">
          <div id="patientsCardsContainer">
            <div class="no-data">Loading patients...</div>
          </div>
        </div>

        <!-- EXPORT ACTIONS -->
        <div class="export-actions" style="background: white; padding: 20px; border-radius: 12px; margin-top: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
          <h3 style="margin: 0 0 16px 0; color: #374151;">Export & Actions</h3>
          <div style="display: flex; gap: 12px;">
            <button id="exportCsvBtn" style="padding: 10px 20px; background: #50BFC3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Export CSV</button>
            <button id="exportPdfBtn" style="padding: 10px 20px; background: #6366f1; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Export PDF</button>
          </div>
        </div>
      </section>

      <!-- ALERTS SECTION -->
      <section id="alertsSection" class="section">
        <h2>All Alerts</h2>
        <div id="allAlerts"></div>
      </section>

      <!-- MESSAGES SECTION -->
      <section id="messagesSection" class="section">
        <h2>Messages</h2>
        <p>Select a patient to start chat.</p>
      </section>

      <!-- SETTINGS SECTION -->
      <section id="settingsSection" class="section">
        <h2>Settings</h2>
        <label>
          Notifications
          <input type="checkbox" checked />
        </label>
      </section>

    </div>

  </main>

  <!-- PATIENT DETAIL PANEL -->
  <div class="patient-panel" id="patientPanel">
    <div class="panel-header">
      <h3 id="panelPatientName">Patient Details</h3>
      <button class="panel-close" onclick="closePatientPanel()">Ã—</button>
    </div>
    <div class="panel-content">
      <div class="patient-info" id="patientInfo">
        <!-- Patient info will be populated here -->
      </div>
      <div class="section-title">Recent Check-ins</div>
      <div id="patientCheckins">
        <!-- Check-ins will be populated here -->
      </div>
      
      <div class="section-title">Chat with Patient</div>
      <div class="chat-container" id="chatContainer">
        <!-- Chat messages will appear here -->
      </div>
      <div class="chat-input-container">
        <input type="text" class="chat-input" id="chatInput" placeholder="Type your message...">
        <button class="send-btn" id="sendChatBtn">Send</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { db, auth } from "./firebase.js";
    import { collection, query, where, orderBy, onSnapshot, doc, updateDoc, getDocs, getDoc, addDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
    import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

    let currentPatients = [];

    // Protect doctor dashboard with role checking
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        console.log("No user logged in, redirecting to login...");
        window.location.href = "login.html";
        return;
      }

      try {
        // Check user role
        const userDoc = await getDoc(doc(db, "users", user.uid));
        
        if (!userDoc.exists()) {
          console.log("User role not found, redirecting to login...");
          await auth.signOut();
          window.location.href = "login.html";
          return;
        }

        const userRole = userDoc.data().role;
        
        if (userRole !== "doctor") {
          console.log("Access denied: not a doctor, redirecting...");
          window.location.href = "login.html";
          return;
        }

        console.log("Doctor access granted:", user.uid);
        
        // Initialize dashboard when user is authenticated and authorized
        initializeDashboard();
      } catch (error) {
        console.error("Error checking user role:", error);
        window.location.href = "login.html";
      }
    });

    // Initialize dashboard
    function initializeDashboard() {
      loadPatients();
      loadAlerts();
      setupNavigation();
      setupExportActions();
      updateExecutiveStats();
      simulateDataLoading();
    }

    // Simulate realistic data loading
    function simulateDataLoading() {
      setTimeout(() => {
        // Update loading states to show realistic data
        const loadingElements = document.querySelectorAll('.no-data');
        loadingElements.forEach(el => {
          if (el.textContent.includes('Loading')) {
            el.textContent = 'Up to date';
          }
        });
      }, 1200);
    }

    // Update executive stats
    function updateExecutiveStats() {
      const trackedPatients = JSON.parse(localStorage.getItem("myTrackedPatients")) || [];
      document.getElementById('totalPatients').textContent = trackedPatients.length;
      
      // Update stats with real-time data
      const alertsQuery = query(
        collection(db, "alerts"),
        where("resolved", "==", false)
      );
      
      onSnapshot(alertsQuery, (snapshot) => {
        const criticalCount = snapshot.docs.filter(doc => 
          doc.data().type === 'CRITICAL'
        ).length;
        document.getElementById('criticalAlerts').textContent = criticalCount;
      });
    }

    // Setup export actions
    function setupExportActions() {
      document.getElementById('exportCsvBtn').onclick = exportToCSV;
      document.getElementById('exportPdfBtn').onclick = exportToPDF;
    }

    // Export to CSV
    async function exportToCSV() {
      const trackedPatients = JSON.parse(localStorage.getItem("myTrackedPatients")) || [];
      if (trackedPatients.length === 0) {
        alert('No patients to export');
        return;
      }

      const csvData = [];
      csvData.push(['Patient ID', 'Name', 'Pain Level', 'Status', 'Last Update']);

      for (const patientId of trackedPatients) {
        try {
          const checkinsQuery = query(
            collection(db, "checkins"),
            where("patientId", "==", patientId),
            orderBy("createdAt", "desc"),
            limit(1)
          );
          
          const snapshot = await getDocs(checkinsQuery);
          if (!snapshot.empty) {
            const data = snapshot.docs[0].data();
            const status = data.painLevel >= 8 ? 'CRITICAL' : 
                          data.painLevel >= 5 ? 'CHECK' : 'STABLE';
            const lastUpdate = new Date(data.createdAt.seconds * 1000).toLocaleDateString();
            
            csvData.push([
              patientId.substring(0, 8) + '...',
              data.patientName || 'N/A',
              data.painLevel + '/10',
              status,
              lastUpdate
            ]);
          }
        } catch (error) {
          console.error('Error fetching patient data:', error);
        }
      }

      const csvContent = csvData.map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `patients_export_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      
      URL.revokeObjectURL(url);
    }

    // Export to PDF (placeholder)
    function exportToPDF() {
      alert('PDF export feature - Integration with jsPDF library required');
    }

    // Setup navigation between sections
    function setupNavigation() {
      const navLinks = document.querySelectorAll(".nav-link");
      const sections = document.querySelectorAll(".page-section");

      navLinks.forEach(link => {
        link.addEventListener("click", () => {
          // Remove active states
          navLinks.forEach(l => l.classList.remove("active"));
          sections.forEach(s => s.classList.remove("active"));

          // Activate selected
          link.classList.add("active");
          const target = link.dataset.target;
          document.getElementById(target).classList.add("active");
        });
      });
    }

    // Load real-time alerts
    function loadAlerts() {
      const alertsQuery = query(
        collection(db, "alerts"),
        where("resolved", "==", false),
        orderBy("createdAt", "desc")
      );

      onSnapshot(alertsQuery, (snapshot) => {
        const alertsContainer = document.getElementById('alertsContainer');
        const allAlertsContainer = document.getElementById('allAlerts');
        
        if (snapshot.empty) {
          alertsContainer.innerHTML = '<div class="no-data">No active alerts</div>';
          allAlertsContainer.innerHTML = '<div class="no-data">No active alerts</div>';
          return;
        }

        const alertsHTML = snapshot.docs.map(doc => {
          const alert = doc.data();
          const alertClass = alert.type?.toLowerCase() || 'warning';
          const timeAgo = alert.createdAt ? 
            getTimeAgo(new Date(alert.createdAt.seconds * 1000)) : 
            'Just now';

          return `
            <div class="alert-card ${alertClass}" onclick="openPatientFromAlert('${alert.patientId}')">
              <div class="alert-header">
                <span class="alert-patient">${alert.patientId?.substring(0, 8)}... - Pain ${alert.painLevel}</span>
                <span class="alert-time">${timeAgo}</span>
              </div>
              <div class="alert-message">${alert.type}: ${alert.symptoms?.join(', ') || 'High pain level'}</div>
              <button class="resolve-btn" onclick="event.stopPropagation(); resolveAlert('${doc.id}')">
                Mark Resolved
              </button>
            </div>
          `;
        }).join('');

        // Update both containers
        alertsContainer.innerHTML = alertsHTML;
        allAlertsContainer.innerHTML = alertsHTML;
      });
    }

    // Resolve alert
    window.resolveAlert = async function(alertId) {
      try {
        await updateDoc(doc(db, "alerts", alertId), {
          resolved: true,
          resolvedAt: new Date()
        });
      } catch (error) {
        console.error('Error resolving alert:', error);
      }
    };

    // Open patient from alert
    window.openPatientFromAlert = function(patientId) {
      openPatientPanel(patientId);
    };

    // Load patients with real-time updates from checkins collection
    function loadPatients() {
      const checkinsQuery = query(
        collection(db, "checkins"),
        orderBy("createdAt", "desc")
      );

      onSnapshot(checkinsQuery, (snapshot) => {
        const patientsCardsContainer = document.getElementById('patientsCardsContainer');
        
        if (snapshot.empty) {
          patientsCardsContainer.innerHTML = '<div class="no-data">No patient data available</div>';
          return;
        }

        // Clear existing data
        patientsCardsContainer.innerHTML = "";
        currentPatients = [];

        // Group by patient ID to get latest data
        const patientMap = new Map();
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!patientMap.has(data.patientId) || 
              patientMap.get(data.patientId).createdAt.seconds < data.createdAt.seconds) {
            patientMap.set(data.patientId, data);
          }
        });

        patientMap.forEach(data => {
          currentPatients.push(data);

          // Status logic
          const painLevel = data.painLevel;
          let statusClass = 'stable';
          let statusText = 'ðŸŸ¢ Stable';
          let trendClass = 'trend-stable';
          let trendText = 'â†’ Stable';
          
          if (painLevel >= 8) {
            statusClass = 'critical';
            statusText = 'ðŸ”´ Critical';
            trendClass = 'trend-rising';
            trendText = 'â†‘ Rising';
          } else if (painLevel >= 5) {
            statusClass = 'check';
            statusText = 'ðŸŸ¡ Check';
            trendClass = 'trend-stable';
            trendText = 'â†’ Monitor';
          }

          // Calculate days since
          const daysSince = Math.floor((new Date() - new Date(data.createdAt.seconds * 1000)) / (1000 * 60 * 60 * 24));
          const timeAgo = getTimeAgo(new Date(data.createdAt.seconds * 1000));

          const card = `
            <div class="patient-card ${statusClass}" onclick="openPatientPanel('${data.patientId}')">
              <div class="card-header">
                <div class="patient-name">${data.patientName || data.patientId?.substring(0, 8) + '...' || 'Unknown'}</div>
                <div class="trend-indicator ${trendClass}">${trendText}</div>
              </div>
              
              <div class="card-stats">
                <div class="stat-item">
                  <div class="stat-value">${painLevel}</div>
                  <div class="stat-label">Pain Level</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">${daysSince}</div>
                  <div class="stat-label">Days</div>
                </div>
                <div class="stat-item">
                  <div class="stat-value">${data.symptoms?.length || 0}</div>
                  <div class="stat-label">Symptoms</div>
                </div>
              </div>
              
              <div style="font-size: 12px; color: #64748b; margin-bottom: 12px;">
                Last update: ${timeAgo}
              </div>
              
              <div class="card-actions">
                <button class="action-btn" onclick="event.stopPropagation(); openPatientPanel('${data.patientId}')">
                  View Details
                </button>
                <button class="action-btn video-btn" onclick="event.stopPropagation(); startVideoCall('${data.patientId}')">
                  ðŸ“¹ Video Call
                </button>
              </div>
            </div>
          `;

          patientsCardsContainer.insertAdjacentHTML("beforeend", card);
        });

        updateExecutiveStats();
      });
    }

    // Start video call (placeholder)
    window.startVideoCall = function(patientId) {
      alert(`Starting video call with patient ${patientId.substring(0, 8)}...\n\nIntegration with Zoom/Meet API required for production.`);
    };

    // Render patients table
    function renderPatients(patients) {
      const patientsTableBody = document.getElementById('patientsTableBody');
      
      if (patients.length === 0) {
        patientsTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No patients match the current filter</td></tr>';
        return;
      }

      const patientsHTML = patients.map(patient => {
        const painLevel = patient.painLevel;
        const daysSince = Math.floor((new Date() - new Date(patient.createdAt.toDate())) / (1000 * 60 * 60 * 24));
        
        // Status logic
        let statusClass = 'stable';
        let statusText = 'ðŸŸ¢ Stable';
        let painClass = 'pain-stable';
        let rowClass = 'patient-row';
        
        if (painLevel >= 8) {
          statusClass = 'critical';
          statusText = 'ðŸ”´ Critical';
          painClass = 'pain-critical';
          rowClass = 'patient-row critical';
        } else if (painLevel >= 5) {
          statusClass = 'check';
          statusText = 'ðŸŸ¡ Check';
          painClass = 'pain-moderate';
        }

        const timeAgo = getTimeAgo(patient.createdAt.toDate());

        return `
          <tr class="${rowClass}" onclick="openPatientPanel('${patient.patientId}')">
            <td>${patient.patientId.substring(0, 8)}...</td>
            <td>Recovery</td>
            <td>${daysSince} days</td>
            <td><span class="pain-level ${painClass}">${painLevel}/10</span></td>
            <td><span class="status-badge status-${statusClass}">${statusText}</span></td>
            <td>${timeAgo}</td>
          </tr>
        `;
      }).join('');

      patientsTableBody.innerHTML = patientsHTML;
    }

    // Filter functionality
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        // Update active filter
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        const filter = btn.dataset.filter;
        const rows = document.querySelectorAll('.patient-row');
        
        rows.forEach(row => {
          if (filter === 'all') {
            row.style.display = '';
          } else if (filter === 'critical') {
            row.style.display = row.classList.contains('critical') ? '' : 'none';
          } else if (filter === 'stable') {
            row.style.display = row.classList.contains('stable') ? '' : 'none';
          }
        });
      });
    });

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('.patient-row');
      
      rows.forEach(row => {
        const patientName = row.cells[0].textContent.toLowerCase();
        row.style.display = patientName.includes(searchTerm) ? '' : 'none';
      });
    });

    // Patient panel functions
    window.openPatientPanel = async function(patientId) {
      const panel = document.getElementById('patientPanel');
      const patientName = document.getElementById('panelPatientName');
      const patientInfo = document.getElementById('patientInfo');
      const patientCheckins = document.getElementById('patientCheckins');
      
      patientName.textContent = `Patient: ${patientId.substring(0, 8)}...`;
      
      // Load patient info
      try {
        const patientDoc = await getDoc(doc(db, "patients", patientId));
        if (patientDoc.exists()) {
          const data = patientDoc.data();
          patientInfo.innerHTML = `
            <div class="info-item">
              <span class="info-label">Name:</span>
              <span class="info-value">${data.name || 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Email:</span>
              <span class="info-value">${data.email || 'N/A'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Role:</span>
              <span class="info-value">${data.role || 'N/A'}</span>
            </div>
          `;
        }
        
        // Load recent check-ins
        const checkinsQuery = query(
          collection(db, "dailyCheckins"),
          where("patientId", "==", patientId),
          orderBy("createdAt", "desc")
        );
        
        const checkinsSnapshot = await getDocs(checkinsQuery);
        
        if (checkinsSnapshot.empty) {
          patientCheckins.innerHTML = '<div class="no-data">No check-ins available</div>';
        } else {
          const checkinsHTML = checkinsSnapshot.docs.map(doc => {
            const checkin = doc.data();
            return `
              <div style="padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 8px;">
                <div><strong>Pain:</strong> ${checkin.painLevel}/10</div>
                <div><strong>Symptoms:</strong> ${checkin.symptoms.join(', ') || 'None'}</div>
                <div><strong>Date:</strong> ${checkin.date}</div>
              </div>
            `;
          }).join('');
          
          patientCheckins.innerHTML = checkinsHTML;
        }
        
        // Setup chat for this patient
        setupPatientChat(patientId);
        
      } catch (error) {
        console.error('Error loading patient details:', error);
        patientInfo.innerHTML = '<div class="no-data">Error loading patient information</div>';
      }
      
      panel.classList.add('open');
    };

    // Setup patient chat
    function setupPatientChat(patientId) {
      const chatContainer = document.getElementById('chatContainer');
      const chatInput = document.getElementById('chatInput');
      const sendBtn = document.getElementById('sendChatBtn');
      
      const chatId = `chat_${patientId}_doc_001`;
      
      // Load existing messages
      const messagesQuery = query(
        collection(db, "chats", chatId, "messages"),
        orderBy("timestamp", "asc")
      );
      
      onSnapshot(messagesQuery, (snapshot) => {
        const messagesHTML = snapshot.docs.map(doc => {
          const message = doc.data();
          const isDoctor = message.senderType === 'doctor';
          const messageClass = isDoctor ? 'doctor' : 'patient';
          
          return `
            <div class="chat-message ${messageClass}">
              <div style="font-size: 12px; color: #64748b; margin-bottom: 4px;">
                ${isDoctor ? 'Doctor' : 'Patient'}
              </div>
              ${message.text}
            </div>
          `;
        }).join('');
        
        chatContainer.innerHTML = messagesHTML || '<div class="no-data">No messages yet</div>';
        chatContainer.scrollTop = chatContainer.scrollHeight;
      });
      
      // Send message function
      const sendMessage = async () => {
        const message = chatInput.value.trim();
        if (!message) return;
        
        try {
          // Create chat document if it doesn't exist
          await setDoc(doc(db, "chats", chatId), {
            participants: [patientId, "doc_001"],
            lastMessage: message,
            lastMessageTime: serverTimestamp()
          }, { merge: true });
          
          // Add message
          await addDoc(collection(db, "chats", chatId, "messages"), {
            senderId: "doc_001",
            senderType: "doctor",
            text: message,
            timestamp: serverTimestamp()
          });
          
          chatInput.value = '';
        } catch (error) {
          console.error('Error sending message:', error);
        }
      };
      
      // Event listeners
      sendBtn.onclick = sendMessage;
      chatInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          sendMessage();
        }
      };
    }
    };

    window.closePatientPanel = function() {
      document.getElementById('patientPanel').classList.remove('open');
    };

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await auth.signOut();
        localStorage.removeItem("myTrackedPatients");
        window.location.href = "login.html";
      } catch (error) {
        console.error('Error signing out:', error);
      }
    });

    // Helper function for time ago
    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 60) return `${diffMins} min ago`;
      if (diffHours < 24) return `${diffHours} hr ago`;
      return `${diffDays} days ago`;
    }
  </script>

</body>
</html>
